<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.primihub.biz.repository.secondarydb.data.DataModelRepository">
    <select id="queryModelListByProjectId" resultType="com.primihub.biz.entity.data.vo.ProjectModelVo">
        SELECT
            model_id as modelId,
            model_name as modelName,
            model_desc as modelDesc,
            model_type as modelType
        FROM
            data_model
        WHERE
            project_id = #{projectId}
        ORDER BY model_id desc
    </select>

    <select id="queryModelList" resultType="com.primihub.biz.entity.data.vo.ModelListVo">
        SELECT
            dm.model_id AS modelId,
            dm.model_name AS modelName,
            dp.project_name AS projectName,
            dm.resource_num AS resourceNum
        FROM
            data_model dm,
            data_project dp
        WHERE
            dm.project_id = dp.id
            and dm.is_draft = 1
            <include refid="listwhere"></include>
        GROUP BY
            dm.model_id,
            dm.model_name,
            dm.resource_num,
            dp.project_name
        ORDER BY dm.model_id desc
        LIMIT #{offset},#{pageSize}
    </select>

    <select id="queryModelListCount" resultType="java.lang.Integer">
        SELECT
            count(dm.model_id)
        FROM
            data_model dm,
            data_project dp
        WHERE
            dm.project_id = dp.id
            and dm.is_draft = 1
            <include refid="listwhere"></include>
    </select>

    <sql id="listwhere">
        and dm.is_del = 0
        <if test="projectName!=null">and dp.project_name like CONCAT('%',#{projectName,jdbcType=VARCHAR},'%')</if>
        <if test="modelName!=null">and dm.model_name like CONCAT('%',#{modelName,jdbcType=VARCHAR},'%')</if>
        <if test="projectId!=null">and dp.id = #{projectId}</if>
    </sql>

    <select id="queryModelById" resultType="com.primihub.biz.entity.data.vo.ModelVo">
        SELECT
            model_id as modelId,
            model_name as modelName,
            model_desc as modelDesc,
            model_type as modelType,
            project_id as projectId,
            resource_num as resourceNum,
            y_value_column as yValueColumn,
            is_draft as isDraft,
            create_date as createDate
        FROM
            data_model
        WHERE
            model_id = #{modelId}
    </select>

    <select id="queryModelResource" resultType="com.primihub.biz.entity.data.vo.ModelResourceVo">
        SELECT
            resource_id as resourceId
        FROM
            data_mr
        WHERE
            model_id = #{modelId}
            and task_id = #{taskId}
    </select>

    <select id="queryModelQuotaVoList" resultType="com.primihub.biz.entity.data.vo.ModelQuotaVo">
        SELECT
            quota_id as quotaId,
            quota_type as quotaType,
            quota_images as quotaImage,
            auc as auc,
            ks as ks,
            gini as gini,
            `precision` as `precision`,
            recall as recall,
            f1_score as f1Score
        FROM
            data_model_quota
        WHERE
            model_id = #{modelId}
    </select>
    <select id="queryModelCountByProjectId" resultType="com.primihub.biz.entity.data.vo.ProjectModelNumVo">
        select project_id projectId,count(model_id) modeNum from data_model
        where project_id in
        <foreach collection="projectIds" index="index" item="item" open="("
                 separator="," close=")">
            #{item}
        </foreach>
        GROUP BY project_id
    </select>
    <select id="queryModelComponentByParams" resultType="com.primihub.biz.entity.data.po.DataComponent">
            SELECT
                component_id as componentId,
                model_id as modelId,
                component_code as componentCode,
                component_name as componentName,
                shape,
                width,
                height,
                coordinate_y as coordinateY,
                coordinate_x as coordinateY ,
                data_json as dataJson,
                component_state as componentState,
                start_time as startTime,
                end_time as endTime
            FROM
                data_component
            <where>
                <if test="modelId!=null and modelId!=0">
                    and model_id = #{modelId}
                </if>
                <if test="componentCode!=null and componentCode!=0">
                    and component_code = #{componentCode}
                </if>
                <if test="taskId!=null and taskId!=0">
                    and task_id = #{taskId}
                </if>
            </where>
    </select>
    <select id="queryModelComponenJsonByUserId" resultType="com.primihub.biz.entity.data.vo.ModelComponentJson">
        select model_id as modelId, component_json as componentJson,
               model_desc as modelDesc,model_desc as modelDesc
        from data_model where
            <choose>
                <when test="modelId!=null">
                    model_id = #{modelId}
                </when>
                <otherwise>
                    user_id = #{userId}
                    <if test="isDraft!=null">
                        and is_draft = #{isDraft}
                    </if>
                    <if test="projectId!=null">
                        and project_id = #{projectId}
                    </if>
                </otherwise>
            </choose>
        LIMIT 1
    </select>
    <select id="queryDataModelById" resultType="com.primihub.biz.entity.data.po.DataModel">
        SELECT
            model_id as modelId,
            model_uuid as modelUUID,
            model_name as modelName,
            model_desc as modelDesc,
            model_type as modelType,
            project_id projectId,
            resource_num as resourceNum,
            y_value_column as yValueColumn,
            component_speed as componentSpeed,
            train_type as trainType,
            is_draft as isDraft,
            user_id as userId,
            organ_id as organId,
            component_json as componentJson,
            is_del as isDel,
            create_date as createDate,
            update_date as updateDate
        FROM
            data_model
        WHERE
            model_id = #{modelId}
    </select>
    <select id="queryModelNumByProjectIds" resultType="java.util.Map">
        select
                project_id projectId,count(model_id) statusCount
        from
                data_model
        where project_id in
        <foreach collection="projectIds" index="index" item="item" open="("
                 separator="," close=")">
            #{item}
        </foreach>
        GROUP BY project_id ORDER BY project_id
    </select>
    <select id="queryModelTaskById" resultType="com.primihub.biz.entity.data.po.DataModelTask">
        select
                id,
               model_id as modelId,
               task_id as taskId,
               predict_file as predictFile,
               predict_content as predictContent,
               component_json as componentJson
        from data_model_task
        where task_id = #{taskId}
    </select>
    <select id="queryModelTaskByModelId" resultType="com.primihub.biz.entity.data.po.DataModelTask">
        select
            id,
            model_id as modelId,
            task_id as taskId,
            predict_file as predictFile,
            predict_content as predictContent,
            component_json as componentJson
        from data_model_task
        where model_id = #{modelId}
        ORDER BY id desc
        LIMIT #{offset},#{pageSize}
    </select>
    <select id="queryModelTaskByModelIdCount" resultType="java.lang.Integer">
        select
            count(id)
        from data_model_task
        where model_id = #{modelId}
        ORDER BY id
    </select>
    <select id="queryModelLatestTask" resultType="java.util.Map">
        select
               mt.model_id modelId,mt.task_id taskId,dt.task_state taskState
        from (
                select
                        DISTINCT model_id,max(task_id) task_id
                from data_model_task
                where model_id in
                <foreach collection="modelIds" index="index" item="item" open="("
                         separator="," close=")">
                    #{item}
                </foreach>
                GROUP BY model_id
            ) mt,data_task dt
        where mt.task_id = dt.task_id
    </select>
    <select id="queryDataModelByUUID" resultType="com.primihub.biz.entity.data.po.DataModel">
        SELECT
            model_id as modelId,
            model_uuid as modelUUID,
            model_name as modelName,
            model_desc as modelDesc,
            model_type as modelType,
            project_id projectId,
            resource_num as resourceNum,
            y_value_column as yValueColumn,
            component_speed as componentSpeed,
            train_type as trainType,
            is_draft as isDraft,
            user_id as userId,
            organ_id as organId,
            component_json as componentJson,
            is_del as isDel,
            create_date as createDate,
            update_date as updateDate
        FROM
            data_model
        WHERE
            model_uuid = #{modelUUID}
    </select>

</mapper>